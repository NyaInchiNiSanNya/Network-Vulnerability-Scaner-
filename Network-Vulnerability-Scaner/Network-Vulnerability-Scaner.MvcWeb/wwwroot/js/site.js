document.addEventListener('DOMContentLoaded', function () {

    let vulnRequestElements = document.querySelectorAll('#vulnRequest');


    vulnRequestElements.forEach(function (element) {
        element.addEventListener('click', function (event) {
            GetVulnsFromNvdByPortAsync(event);
        });
    });


    let vulnRequestOs = document.querySelectorAll('#port-state');

    vulnRequestElements.forEach(function (element) {
        if (element.textContent.includes('close')) {
            element.style.color = 'red';
        }

        if (element.textContent.includes('open')) {
            element.style.color = 'green';
        }

        if (element.textContent.includes('filtered')) {
            element.style.color = 'darkGoldenRod';
        }
    });
});

async function GetVulnsFromNvdByPortAsync(event) {

    let version = event.target.getAttribute("version");

    let service = event.target.getAttribute("service");

    let portData = {
        version: version,
        service: service
    };

    let resp = await fetch('https://localhost:7143/Scan/GetVulnerability', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(portData)
    });

    if (resp.ok) {
        let jsonText = await resp.text(); 

        var vulns = JSON.parse(jsonText); 

        document.getElementById("workPlaceLeftTop").innerHTML = "";

        document.getElementById("workPlaceLeftBottom").innerHTML = "";

        document.getElementById("leftBack").hidden = true;

        document.getElementById("workplaceL").hidden = false;

        for (let i = 0; i < vulns.nvdReport.length; i++) {

            let report = vulns.nvdReport[i];

            document.getElementById("workPlaceLeftTop").innerHTML += '<span style="font-weight: bold;">' + report.nvdId + '</span>';

            document.getElementById("workPlaceLeftTop").innerHTML += "<br>";

            document.getElementById("workPlaceLeftTop").innerHTML += report.description;

            document.getElementById("workPlaceLeftTop").innerHTML += "<br>";

            document.getElementById("workPlaceLeftTop").innerHTML += '<a href="' + report.reference + '" target="_blank">' + report.reference + '</a>';

            document.getElementById("workPlaceLeftTop").innerHTML += "<br>";

            document.getElementById("workPlaceLeftTop").innerHTML += "<br>";
        }

        for (let i = 0; i < vulns.exploitDbReport.length; i++) {

            let report = vulns.exploitDbReport[i];

            document.getElementById("workPlaceLeftBottom").innerHTML += '<span style="font-weight: bold;">' + report.exploitTitle + '</span>' + '<br>' + report.fileType + '<br>' + '<a href="' + report.url + '" target="_blank">' + "Описание" + '</a>' + '<a href="' + report.downloadExp + '" target="_blank">' + "Скачать" + '</a>'+'<br>' +'</br>';

        }

    } else {

        console.error('Ошибка при выполнении запроса:', resp.status);
    }

}
